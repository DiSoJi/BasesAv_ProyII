"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _require = require('./lib/csprng-bytes'),
    csprngBytes = _require.csprngBytes;

var _require2 = require('./lib/prng-bytes'),
    prngBytes = _require2.prngBytes;

var BITS_PER_BYTE = 8;
var abs = Math.abs,
    ceil = Math.ceil,
    floor = Math.floor,
    log2 = Math.log2,
    round = Math.round;

var gcd = function gcd(a, b) {
  var la = a;
  var lb = b;

  while (lb !== 0) {
    var _ref = [lb, la % lb];
    la = _ref[0];
    lb = _ref[1];
  }

  return abs(la);
};

var lcm = function lcm(a, b) {
  return a / gcd(a, b) * b;
};

var genNdxFn = function genNdxFn(bitsPerChar) {
  // If BITS_PER_BYTEs is a multiple of bitsPerChar, we can slice off an integer number
  // of chars per byte.
  if (lcm(bitsPerChar, BITS_PER_BYTE) === BITS_PER_BYTE) {
    return function (chunk, slice, bytes) {
      var lShift = bitsPerChar;
      var rShift = BITS_PER_BYTE - bitsPerChar;
      return (bytes[chunk] << lShift * slice & 0xff) >> rShift;
    };
  } // Otherwise, while slicing off bits per char, we can possibly straddle two
  // of bytes, so a more work is involved


  var slicesPerChunk = lcm(bitsPerChar, BITS_PER_BYTE) / BITS_PER_BYTE;
  return function (chunk, slice, bytes) {
    var bNum = chunk * slicesPerChunk;
    var offset = slice * bitsPerChar / BITS_PER_BYTE;
    var lOffset = floor(offset);
    var rOffset = ceil(offset);
    var rShift = BITS_PER_BYTE - bitsPerChar;
    var lShift = slice * bitsPerChar % BITS_PER_BYTE;
    var ndx = (bytes[bNum + lOffset] << lShift & 0xff) >> rShift;
    var r1Bits = (rOffset + 1) * BITS_PER_BYTE;
    var s1Bits = (slice + 1) * bitsPerChar;
    var rShiftIt = (r1Bits - s1Bits) % BITS_PER_BYTE;

    if (rShift < rShiftIt) {
      ndx += bytes[bNum + rOffset] >> rShiftIt;
    }

    return ndx;
  };
};

var CharSet =
/*#__PURE__*/
function () {
  function CharSet(chars) {
    (0, _classCallCheck2["default"])(this, CharSet);

    if (!(typeof chars === 'string' || chars instanceof String)) {
      throw new Error('Invalid chars: Must be string');
    }

    var length = chars.length;

    if (![2, 4, 8, 16, 32, 64].includes(length)) {
      throw new Error('Invalid char count: must be one of 2,4,8,16,32,64');
    } // Ensure no repeated characters


    for (var i = 0; i < length; i += 1) {
      var c = chars.charAt(i);

      for (var j = i + 1; j < length; j += 1) {
        if (c === chars.charAt(j)) {
          throw new Error('Characters not unique');
        }
      }
    }

    this.chars = chars;
    this.bitsPerChar = floor(log2(length));
    this.length = length;
    this.ndxFn = genNdxFn(this.bitsPerChar);
    this.charsPerChunk = lcm(this.bitsPerChar, BITS_PER_BYTE) / this.bitsPerChar;
  }

  (0, _createClass2["default"])(CharSet, [{
    key: "bytesNeeded",
    value: function bytesNeeded(bitLen) {
      var count = ceil(bitLen / this.bitsPerChar);
      return ceil(count * this.bitsPerChar / BITS_PER_BYTE);
    }
  }]);
  return CharSet;
}();

var charset64 = new CharSet('ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_');
var charset32 = new CharSet('2346789bdfghjmnpqrtBDFGHJLMNPQRT');
var charset16 = new CharSet('0123456789abcdef');
var charset8 = new CharSet('01234567');
var charset4 = new CharSet('ATCG');
var charset2 = new CharSet('01');

var _stringWithBytes = function stringWithBytes(bytes, bitLen, charset) {
  if (bitLen <= 0) {
    return '';
  }

  var bitsPerChar = charset.bitsPerChar;
  var count = ceil(bitLen / bitsPerChar);

  if (count <= 0) {
    return '';
  }

  var need = ceil(count * (bitsPerChar / BITS_PER_BYTE));

  if (bytes.length < need) {
    throw new Error("Insufficient bytes: need ".concat(need, " and got ").concat(bytes.length));
  }

  var ndxFn = charset.ndxFn,
      charsPerChunk = charset.charsPerChunk,
      chars = charset.chars;
  var chunks = floor(count / charsPerChunk);
  var partials = count % charsPerChunk;
  var string = '';

  for (var chunk = 0; chunk < chunks; chunk += 1) {
    for (var slice = 0; slice < charsPerChunk; slice += 1) {
      var ndx = ndxFn(chunk, slice, bytes);
      string += chars[ndx];
    }
  }

  for (var _slice = 0; _slice < partials; _slice += 1) {
    var _ndx = ndxFn(chunks, _slice, bytes);

    string += chars[_ndx];
  }

  return string;
};

var entropyBits = function entropyBits(total, risk) {
  if (total === 0) {
    return 0;
  }

  var N;

  if (total < 1000) {
    N = log2(total) + log2(total - 1);
  } else {
    N = 2 * log2(total);
  }

  return N + log2(risk) - 1;
};

var Entropy =
/*#__PURE__*/
function () {
  function Entropy() {
    var params = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {
      bits: 128,
      charset: charset32
    };
    (0, _classCallCheck2["default"])(this, Entropy);

    if (params !== undefined) {
      if (!(params instanceof Object)) {
        throw new Error('Invalid argument for Entropy constructor: Expect params object');
      }

      if (params.bits === undefined && params.charset === undefined && params.total === undefined && params.risk === undefined && params.prng === undefined) {
        throw new Error('Invalid Entropy params');
      }

      if (params.bits !== undefined) {
        if (typeof params.bits !== 'number') {
          throw new Error('Invalid Entropy params: non-numeric bits');
        }

        if (params.bits < 0) {
          throw new Error('Invalid Entropy params: negative bits');
        }
      }

      if (params.total !== undefined) {
        if (typeof params.total !== 'number') {
          throw new Error('Invalid Entropy params: non-numeric total');
        }

        if (params.total < 1) {
          throw new Error('Invalid Entropy params: non-positive total');
        }
      }

      if (params.risk !== undefined) {
        if (typeof params.risk !== 'number') {
          throw new Error('Invalid Entropy params: non-numeric risk');
        }

        if (params.risk < 1) {
          throw new Error('Invalid Entropy params: non-positive risk');
        }
      }

      if (params.risk !== undefined && typeof params.risk !== 'number') {
        throw new Error('Invalid Entropy params: non-numeric risk');
      }

      if (params.total !== undefined && params.risk === undefined || params.total === undefined && params.risk !== undefined) {
        throw new Error('Invalid Entropy params: total and risk must be paired');
      }

      if (params.bits !== undefined && (params.total !== undefined || params.risk !== undefined)) {
        throw new Error('Invalid Entropy params: bits with total and/or risk');
      }
    }

    var bitLen;

    if (params.bits) {
      bitLen = round(params.bits);
    } else if (params.total && params.risk) {
      bitLen = round(entropyBits(params.total, params.risk));
    } else {
      bitLen = 128;
    }

    var charset;

    if (params.charset instanceof CharSet) {
      var cs = params.charset;
      charset = cs;
    } else if (typeof params.charset === 'string' || params.charset instanceof String) {
      charset = new CharSet(params.charset);
    } else {
      charset = charset32;
    }

    this.charset = charset;
    this.bitLen = bitLen;
    this.prng = params.prng || false;
  }

  (0, _createClass2["default"])(Entropy, [{
    key: "smallID",
    value: function smallID() {
      var charset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.charset;
      return this.string(29, charset);
    }
  }, {
    key: "mediumID",
    value: function mediumID() {
      var charset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.charset;
      return this.string(69, charset);
    }
  }, {
    key: "largeID",
    value: function largeID() {
      var charset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.charset;
      return this.string(99, charset);
    }
  }, {
    key: "sessionID",
    value: function sessionID() {
      var charset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.charset;
      return this.string(128, charset);
    }
  }, {
    key: "token",
    value: function token() {
      var charset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.charset;
      return this.string(256, charset);
    }
  }, {
    key: "string",
    value: function string() {
      var bitLen = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.bitLen;
      var charset = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.charset;
      var bytesNeeded = charset.bytesNeeded(bitLen);
      var bytes = this.prng ? prngBytes(bytesNeeded) : csprngBytes(bytesNeeded);
      return this.stringWithBytes(bytes, bitLen, charset);
    }
  }, {
    key: "stringWithBytes",
    value: function stringWithBytes(bytes) {
      var bitLen = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.bitLen;
      var charset = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : this.charset;
      return _stringWithBytes(bytes, bitLen, charset);
    }
  }, {
    key: "bytesNeeded",
    value: function bytesNeeded() {
      var bitLen = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.bitLen;
      var charset = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.charset;
      return charset.bytesNeeded(bitLen);
    }
  }, {
    key: "chars",
    value: function chars() {
      return this.charset.chars;
    }
  }, {
    key: "bits",
    value: function bits() {
      return this.bitLen;
    }
  }, {
    key: "use",
    value: function use(charset) {
      if (!(charset instanceof CharSet)) {
        throw new Error('Invalid CharSet');
      }

      this.charset = charset;
    }
  }, {
    key: "useChars",
    value: function useChars(chars) {
      if (!(typeof chars === 'string' || chars instanceof String)) {
        throw new Error('Invalid chars: Must be string');
      }

      this.use(new CharSet(chars));
    }
  }], [{
    key: "bits",
    value: function bits(total, risk) {
      return entropyBits(total, risk);
    }
  }]);
  return Entropy;
}();

module.exports = {
  CharSet: CharSet,
  Entropy: Entropy,
  charset2: charset2,
  charset4: charset4,
  charset8: charset8,
  charset16: charset16,
  charset32: charset32,
  charset64: charset64
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VudHJvcHktc3RyaW5nLmpzIl0sIm5hbWVzIjpbInJlcXVpcmUiLCJjc3BybmdCeXRlcyIsInBybmdCeXRlcyIsIkJJVFNfUEVSX0JZVEUiLCJhYnMiLCJNYXRoIiwiY2VpbCIsImZsb29yIiwibG9nMiIsInJvdW5kIiwiZ2NkIiwiYSIsImIiLCJsYSIsImxiIiwibGNtIiwiZ2VuTmR4Rm4iLCJiaXRzUGVyQ2hhciIsImNodW5rIiwic2xpY2UiLCJieXRlcyIsImxTaGlmdCIsInJTaGlmdCIsInNsaWNlc1BlckNodW5rIiwiYk51bSIsIm9mZnNldCIsImxPZmZzZXQiLCJyT2Zmc2V0IiwibmR4IiwicjFCaXRzIiwiczFCaXRzIiwiclNoaWZ0SXQiLCJDaGFyU2V0IiwiY2hhcnMiLCJTdHJpbmciLCJFcnJvciIsImxlbmd0aCIsImluY2x1ZGVzIiwiaSIsImMiLCJjaGFyQXQiLCJqIiwibmR4Rm4iLCJjaGFyc1BlckNodW5rIiwiYml0TGVuIiwiY291bnQiLCJjaGFyc2V0NjQiLCJjaGFyc2V0MzIiLCJjaGFyc2V0MTYiLCJjaGFyc2V0OCIsImNoYXJzZXQ0IiwiY2hhcnNldDIiLCJzdHJpbmdXaXRoQnl0ZXMiLCJjaGFyc2V0IiwibmVlZCIsImNodW5rcyIsInBhcnRpYWxzIiwic3RyaW5nIiwiZW50cm9weUJpdHMiLCJ0b3RhbCIsInJpc2siLCJOIiwiRW50cm9weSIsInBhcmFtcyIsImJpdHMiLCJ1bmRlZmluZWQiLCJPYmplY3QiLCJwcm5nIiwiY3MiLCJieXRlc05lZWRlZCIsInVzZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O2VBQXdCQSxPQUFPLENBQUMsb0JBQUQsQztJQUF2QkMsVyxZQUFBQSxXOztnQkFDY0QsT0FBTyxDQUFDLGtCQUFELEM7SUFBckJFLFMsYUFBQUEsUzs7QUFFUixJQUFNQyxhQUFhLEdBQUcsQ0FBdEI7SUFFRUMsRyxHQUNFQyxJLENBREZELEc7SUFBS0UsSSxHQUNIRCxJLENBREdDLEk7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QUFNZkQsRUFBQUEsU0FBUyxFQUFUQSxTQU5lO0FBT2ZELEVBQUFBLFNBQVMsRUFBVEEsU0FQZTtBQVFmRCxFQUFBQSxTQUFTLEVBQVRBO0FBUmUsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IGNzcHJuZ0J5dGVzIH0gPSByZXF1aXJlKCcuL2xpYi9jc3BybmctYnl0ZXMnKVxuY29uc3QgeyBwcm5nQnl0ZXMgfSA9IHJlcXVpcmUoJy4vbGliL3BybmctYnl0ZXMnKVxuXG5jb25zdCBCSVRTX1BFUl9CWVRFID0gOFxuY29uc3Qge1xuICBhYnMsIGNlaWwsIGZsb29yLCBsb2cyLCByb3VuZFxufSA9IE1hdGhcblxuY29uc3QgZ2NkID0gKGEsIGIpID0+IHtcbiAgbGV0IGxhID0gYVxuICBsZXQgbGIgPSBiXG4gIHdoaWxlIChsYiAhPT0gMCkge1xuICAgIFtsYSwgbGJdID0gW2xiLCBsYSAlIGxiXVxuICB9XG4gIHJldHVybiBhYnMobGEpXG59XG5jb25zdCBsY20gPSAoYSwgYikgPT4gKGEgLyBnY2QoYSwgYikpICogYlxuXG5jb25zdCBnZW5OZHhGbiA9IChiaXRzUGVyQ2hhcikgPT4ge1xuICAvLyBJZiBCSVRTX1BFUl9CWVRFcyBpcyBhIG11bHRpcGxlIG9mIGJpdHNQZXJDaGFyLCB3ZSBjYW4gc2xpY2Ugb2ZmIGFuIGludGVnZXIgbnVtYmVyXG4gIC8vIG9mIGNoYXJzIHBlciBieXRlLlxuICBpZiAobGNtKGJpdHNQZXJDaGFyLCBCSVRTX1BFUl9CWVRFKSA9PT0gQklUU19QRVJfQllURSkge1xuICAgIHJldHVybiAoY2h1bmssIHNsaWNlLCBieXRlcykgPT4ge1xuICAgICAgY29uc3QgbFNoaWZ0ID0gYml0c1BlckNoYXJcbiAgICAgIGNvbnN0IHJTaGlmdCA9IEJJVFNfUEVSX0JZVEUgLSBiaXRzUGVyQ2hhclxuICAgICAgcmV0dXJuICgoYnl0ZXNbY2h1bmtdIDw8IChsU2hpZnQgKiBzbGljZSkpICYgMHhmZikgPj4gclNoaWZ0XG4gICAgfVxuICB9XG5cbiAgLy8gT3RoZXJ3aXNlLCB3aGlsZSBzbGljaW5nIG9mZiBiaXRzIHBlciBjaGFyLCB3ZSBjYW4gcG9zc2libHkgc3RyYWRkbGUgdHdvXG4gIC8vIG9mIGJ5dGVzLCBzbyBhIG1vcmUgd29yayBpcyBpbnZvbHZlZFxuICBjb25zdCBzbGljZXNQZXJDaHVuayA9IGxjbShiaXRzUGVyQ2hhciwgQklUU19QRVJfQllURSkgLyBCSVRTX1BFUl9CWVRFXG4gIHJldHVybiAoY2h1bmssIHNsaWNlLCBieXRlcykgPT4ge1xuICAgIGNvbnN0IGJOdW0gPSBjaHVuayAqIHNsaWNlc1BlckNodW5rXG5cbiAgICBjb25zdCBvZmZzZXQgPSAoc2xpY2UgKiBiaXRzUGVyQ2hhcikgLyBCSVRTX1BFUl9CWVRFXG4gICAgY29uc3QgbE9mZnNldCA9IGZsb29yKG9mZnNldClcbiAgICBjb25zdCByT2Zmc2V0ID0gY2VpbChvZmZzZXQpXG5cbiAgICBjb25zdCByU2hpZnQgPSBCSVRTX1BFUl9CWVRFIC0gYml0c1BlckNoYXJcbiAgICBjb25zdCBsU2hpZnQgPSAoc2xpY2UgKiBiaXRzUGVyQ2hhcikgJSBCSVRTX1BFUl9CWVRFXG5cbiAgICBsZXQgbmR4ID0gKChieXRlc1tiTnVtICsgbE9mZnNldF0gPDwgbFNoaWZ0KSAmIDB4ZmYpID4+IHJTaGlmdFxuXG4gICAgY29uc3QgcjFCaXRzID0gKHJPZmZzZXQgKyAxKSAqIEJJVFNfUEVSX0JZVEVcbiAgICBjb25zdCBzMUJpdHMgPSAoc2xpY2UgKyAxKSAqIGJpdHNQZXJDaGFyXG5cbiAgICBjb25zdCByU2hpZnRJdCA9IChyMUJpdHMgLSBzMUJpdHMpICUgQklUU19QRVJfQllURVxuICAgIGlmIChyU2hpZnQgPCByU2hpZnRJdCkge1xuICAgICAgbmR4ICs9IGJ5dGVzW2JOdW0gKyByT2Zmc2V0XSA+PiByU2hpZnRJdFxuICAgIH1cbiAgICByZXR1cm4gbmR4XG4gIH1cbn1cblxuY2xhc3MgQ2hhclNldCB7XG4gIGNvbnN0cnVjdG9yKGNoYXJzKSB7XG4gICAgaWYgKCEodHlwZW9mIGNoYXJzID09PSAnc3RyaW5nJyB8fCBjaGFycyBpbnN0YW5jZW9mIFN0cmluZykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjaGFyczogTXVzdCBiZSBzdHJpbmcnKVxuICAgIH1cbiAgICBjb25zdCB7IGxlbmd0aCB9ID0gY2hhcnNcbiAgICBpZiAoIVsyLCA0LCA4LCAxNiwgMzIsIDY0XS5pbmNsdWRlcyhsZW5ndGgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY2hhciBjb3VudDogbXVzdCBiZSBvbmUgb2YgMiw0LDgsMTYsMzIsNjQnKVxuICAgIH1cblxuICAgIC8vIEVuc3VyZSBubyByZXBlYXRlZCBjaGFyYWN0ZXJzXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkge1xuICAgICAgY29uc3QgYyA9IGNoYXJzLmNoYXJBdChpKVxuICAgICAgZm9yIChsZXQgaiA9IGkgKyAxOyBqIDwgbGVuZ3RoOyBqICs9IDEpIHtcbiAgICAgICAgaWYgKGMgPT09IGNoYXJzLmNoYXJBdChqKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2hhcmFjdGVycyBub3QgdW5pcXVlJylcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuY2hhcnMgPSBjaGFyc1xuICAgIHRoaXMuYml0c1BlckNoYXIgPSBmbG9vcihsb2cyKGxlbmd0aCkpXG4gICAgdGhpcy5sZW5ndGggPSBsZW5ndGhcbiAgICB0aGlzLm5keEZuID0gZ2VuTmR4Rm4odGhpcy5iaXRzUGVyQ2hhcilcbiAgICB0aGlzLmNoYXJzUGVyQ2h1bmsgPSBsY20odGhpcy5iaXRzUGVyQ2hhciwgQklUU19QRVJfQllURSkgLyB0aGlzLmJpdHNQZXJDaGFyXG4gIH1cblxuICBieXRlc05lZWRlZChiaXRMZW4pIHtcbiAgICBjb25zdCBjb3VudCA9IGNlaWwoYml0TGVuIC8gdGhpcy5iaXRzUGVyQ2hhcilcbiAgICByZXR1cm4gY2VpbCgoY291bnQgKiB0aGlzLmJpdHNQZXJDaGFyKSAvIEJJVFNfUEVSX0JZVEUpXG4gIH1cbn1cblxuY29uc3QgY2hhcnNldDY0ID0gbmV3IENoYXJTZXQoJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5LV8nKVxuY29uc3QgY2hhcnNldDMyID0gbmV3IENoYXJTZXQoJzIzNDY3ODliZGZnaGptbnBxcnRCREZHSEpMTU5QUVJUJylcbmNvbnN0IGNoYXJzZXQxNiA9IG5ldyBDaGFyU2V0KCcwMTIzNDU2Nzg5YWJjZGVmJylcbmNvbnN0IGNoYXJzZXQ4ID0gbmV3IENoYXJTZXQoJzAxMjM0NTY3JylcbmNvbnN0IGNoYXJzZXQ0ID0gbmV3IENoYXJTZXQoJ0FUQ0cnKVxuY29uc3QgY2hhcnNldDIgPSBuZXcgQ2hhclNldCgnMDEnKVxuXG5jb25zdCBzdHJpbmdXaXRoQnl0ZXMgPSAoYnl0ZXMsIGJpdExlbiwgY2hhcnNldCkgPT4ge1xuICBpZiAoYml0TGVuIDw9IDApIHsgcmV0dXJuICcnIH1cblxuICBjb25zdCB7IGJpdHNQZXJDaGFyIH0gPSBjaGFyc2V0XG4gIGNvbnN0IGNvdW50ID0gY2VpbChiaXRMZW4gLyBiaXRzUGVyQ2hhcilcbiAgaWYgKGNvdW50IDw9IDApIHsgcmV0dXJuICcnIH1cblxuICBjb25zdCBuZWVkID0gY2VpbChjb3VudCAqIChiaXRzUGVyQ2hhciAvIEJJVFNfUEVSX0JZVEUpKVxuICBpZiAoYnl0ZXMubGVuZ3RoIDwgbmVlZCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW5zdWZmaWNpZW50IGJ5dGVzOiBuZWVkICR7bmVlZH0gYW5kIGdvdCAke2J5dGVzLmxlbmd0aH1gKVxuICB9XG5cbiAgY29uc3QgeyBuZHhGbiwgY2hhcnNQZXJDaHVuaywgY2hhcnMgfSA9IGNoYXJzZXRcblxuICBjb25zdCBjaHVua3MgPSBmbG9vcihjb3VudCAvIGNoYXJzUGVyQ2h1bmspXG4gIGNvbnN0IHBhcnRpYWxzID0gY291bnQgJSBjaGFyc1BlckNodW5rXG5cbiAgbGV0IHN0cmluZyA9ICcnXG4gIGZvciAobGV0IGNodW5rID0gMDsgY2h1bmsgPCBjaHVua3M7IGNodW5rICs9IDEpIHtcbiAgICBmb3IgKGxldCBzbGljZSA9IDA7IHNsaWNlIDwgY2hhcnNQZXJDaHVuazsgc2xpY2UgKz0gMSkge1xuICAgICAgY29uc3QgbmR4ID0gbmR4Rm4oY2h1bmssIHNsaWNlLCBieXRlcylcbiAgICAgIHN0cmluZyArPSBjaGFyc1tuZHhdXG4gICAgfVxuICB9XG4gIGZvciAobGV0IHNsaWNlID0gMDsgc2xpY2UgPCBwYXJ0aWFsczsgc2xpY2UgKz0gMSkge1xuICAgIGNvbnN0IG5keCA9IG5keEZuKGNodW5rcywgc2xpY2UsIGJ5dGVzKVxuICAgIHN0cmluZyArPSBjaGFyc1tuZHhdXG4gIH1cbiAgcmV0dXJuIHN0cmluZ1xufVxuXG5jb25zdCBlbnRyb3B5Qml0cyA9ICh0b3RhbCwgcmlzaykgPT4ge1xuICBpZiAodG90YWwgPT09IDApIHsgcmV0dXJuIDAgfVxuICBsZXQgTlxuICBpZiAodG90YWwgPCAxMDAwKSB7XG4gICAgTiA9IGxvZzIodG90YWwpICsgbG9nMih0b3RhbCAtIDEpXG4gIH0gZWxzZSB7XG4gICAgTiA9IDIgKiBsb2cyKHRvdGFsKVxuICB9XG4gIHJldHVybiAoTiArIGxvZzIocmlzaykpIC0gMVxufVxuXG5jbGFzcyBFbnRyb3B5IHtcbiAgY29uc3RydWN0b3IocGFyYW1zID0geyBiaXRzOiAxMjgsIGNoYXJzZXQ6IGNoYXJzZXQzMiB9KSB7XG4gICAgaWYgKHBhcmFtcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpZiAoIShwYXJhbXMgaW5zdGFuY2VvZiBPYmplY3QpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBhcmd1bWVudCBmb3IgRW50cm9weSBjb25zdHJ1Y3RvcjogRXhwZWN0IHBhcmFtcyBvYmplY3QnKVxuICAgICAgfVxuXG4gICAgICBpZiAocGFyYW1zLmJpdHMgPT09IHVuZGVmaW5lZFxuICAgICAgICAgICYmIHBhcmFtcy5jaGFyc2V0ID09PSB1bmRlZmluZWRcbiAgICAgICAgICAmJiBwYXJhbXMudG90YWwgPT09IHVuZGVmaW5lZFxuICAgICAgICAgICYmIHBhcmFtcy5yaXNrID09PSB1bmRlZmluZWRcbiAgICAgICAgICAmJiBwYXJhbXMucHJuZyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBFbnRyb3B5IHBhcmFtcycpXG4gICAgICB9XG5cbiAgICAgIGlmIChwYXJhbXMuYml0cyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLmJpdHMgIT09ICdudW1iZXInKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIEVudHJvcHkgcGFyYW1zOiBub24tbnVtZXJpYyBiaXRzJylcbiAgICAgICAgfVxuICAgICAgICBpZiAocGFyYW1zLmJpdHMgPCAwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIEVudHJvcHkgcGFyYW1zOiBuZWdhdGl2ZSBiaXRzJylcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAocGFyYW1zLnRvdGFsICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXMudG90YWwgIT09ICdudW1iZXInKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIEVudHJvcHkgcGFyYW1zOiBub24tbnVtZXJpYyB0b3RhbCcpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBhcmFtcy50b3RhbCA8IDEpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgRW50cm9weSBwYXJhbXM6IG5vbi1wb3NpdGl2ZSB0b3RhbCcpXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKHBhcmFtcy5yaXNrICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXMucmlzayAhPT0gJ251bWJlcicpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgRW50cm9weSBwYXJhbXM6IG5vbi1udW1lcmljIHJpc2snKVxuICAgICAgICB9XG4gICAgICAgIGlmIChwYXJhbXMucmlzayA8IDEpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgRW50cm9weSBwYXJhbXM6IG5vbi1wb3NpdGl2ZSByaXNrJylcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAocGFyYW1zLnJpc2sgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgcGFyYW1zLnJpc2sgIT09ICdudW1iZXInKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBFbnRyb3B5IHBhcmFtczogbm9uLW51bWVyaWMgcmlzaycpXG4gICAgICB9XG5cbiAgICAgIGlmICgocGFyYW1zLnRvdGFsICE9PSB1bmRlZmluZWQgJiYgcGFyYW1zLnJpc2sgPT09IHVuZGVmaW5lZClcbiAgICAgICAgICB8fCAocGFyYW1zLnRvdGFsID09PSB1bmRlZmluZWQgJiYgcGFyYW1zLnJpc2sgIT09IHVuZGVmaW5lZCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIEVudHJvcHkgcGFyYW1zOiB0b3RhbCBhbmQgcmlzayBtdXN0IGJlIHBhaXJlZCcpXG4gICAgICB9XG5cbiAgICAgIGlmIChwYXJhbXMuYml0cyAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgJiYgKHBhcmFtcy50b3RhbCAhPT0gdW5kZWZpbmVkIHx8IHBhcmFtcy5yaXNrICE9PSB1bmRlZmluZWQpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBFbnRyb3B5IHBhcmFtczogYml0cyB3aXRoIHRvdGFsIGFuZC9vciByaXNrJylcbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgYml0TGVuXG4gICAgaWYgKHBhcmFtcy5iaXRzKSB7XG4gICAgICBiaXRMZW4gPSByb3VuZChwYXJhbXMuYml0cylcbiAgICB9IGVsc2UgaWYgKHBhcmFtcy50b3RhbCAmJiBwYXJhbXMucmlzaykge1xuICAgICAgYml0TGVuID0gcm91bmQoZW50cm9weUJpdHMocGFyYW1zLnRvdGFsLCBwYXJhbXMucmlzaykpXG4gICAgfSBlbHNlIHtcbiAgICAgIGJpdExlbiA9IDEyOFxuICAgIH1cblxuICAgIGxldCBjaGFyc2V0XG4gICAgaWYgKHBhcmFtcy5jaGFyc2V0IGluc3RhbmNlb2YgQ2hhclNldCkge1xuICAgICAgY29uc3QgeyBjaGFyc2V0OiBjcyB9ID0gcGFyYW1zXG4gICAgICBjaGFyc2V0ID0gY3NcbiAgICB9IGVsc2UgaWYgKCh0eXBlb2YgcGFyYW1zLmNoYXJzZXQgPT09ICdzdHJpbmcnIHx8IHBhcmFtcy5jaGFyc2V0IGluc3RhbmNlb2YgU3RyaW5nKSkge1xuICAgICAgY2hhcnNldCA9IG5ldyBDaGFyU2V0KHBhcmFtcy5jaGFyc2V0KVxuICAgIH0gZWxzZSB7XG4gICAgICBjaGFyc2V0ID0gY2hhcnNldDMyXG4gICAgfVxuXG4gICAgdGhpcy5jaGFyc2V0ID0gY2hhcnNldFxuICAgIHRoaXMuYml0TGVuID0gYml0TGVuXG4gICAgdGhpcy5wcm5nID0gcGFyYW1zLnBybmcgfHwgZmFsc2VcbiAgfVxuXG4gIHN0YXRpYyBiaXRzKHRvdGFsLCByaXNrKSB7IHJldHVybiBlbnRyb3B5Qml0cyh0b3RhbCwgcmlzaykgfVxuXG4gIHNtYWxsSUQoY2hhcnNldCA9IHRoaXMuY2hhcnNldCkge1xuICAgIHJldHVybiB0aGlzLnN0cmluZygyOSwgY2hhcnNldClcbiAgfVxuXG4gIG1lZGl1bUlEKGNoYXJzZXQgPSB0aGlzLmNoYXJzZXQpIHtcbiAgICByZXR1cm4gdGhpcy5zdHJpbmcoNjksIGNoYXJzZXQpXG4gIH1cblxuICBsYXJnZUlEKGNoYXJzZXQgPSB0aGlzLmNoYXJzZXQpIHtcbiAgICByZXR1cm4gdGhpcy5zdHJpbmcoOTksIGNoYXJzZXQpXG4gIH1cblxuICBzZXNzaW9uSUQoY2hhcnNldCA9IHRoaXMuY2hhcnNldCkge1xuICAgIHJldHVybiB0aGlzLnN0cmluZygxMjgsIGNoYXJzZXQpXG4gIH1cblxuICB0b2tlbihjaGFyc2V0ID0gdGhpcy5jaGFyc2V0KSB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaW5nKDI1NiwgY2hhcnNldClcbiAgfVxuXG4gIHN0cmluZyhiaXRMZW4gPSB0aGlzLmJpdExlbiwgY2hhcnNldCA9IHRoaXMuY2hhcnNldCkge1xuICAgIGNvbnN0IGJ5dGVzTmVlZGVkID0gY2hhcnNldC5ieXRlc05lZWRlZChiaXRMZW4pXG4gICAgY29uc3QgYnl0ZXMgPSB0aGlzLnBybmcgPyBwcm5nQnl0ZXMoYnl0ZXNOZWVkZWQpIDogY3Nwcm5nQnl0ZXMoYnl0ZXNOZWVkZWQpXG4gICAgcmV0dXJuIHRoaXMuc3RyaW5nV2l0aEJ5dGVzKGJ5dGVzLCBiaXRMZW4sIGNoYXJzZXQpXG4gIH1cblxuICBzdHJpbmdXaXRoQnl0ZXMoXG4gICAgYnl0ZXMsXG4gICAgYml0TGVuID0gdGhpcy5iaXRMZW4sIGNoYXJzZXQgPSB0aGlzLmNoYXJzZXRcbiAgKSB7XG4gICAgcmV0dXJuIHN0cmluZ1dpdGhCeXRlcyhieXRlcywgYml0TGVuLCBjaGFyc2V0KVxuICB9XG5cbiAgYnl0ZXNOZWVkZWQoYml0TGVuID0gdGhpcy5iaXRMZW4sIGNoYXJzZXQgPSB0aGlzLmNoYXJzZXQpIHtcbiAgICByZXR1cm4gY2hhcnNldC5ieXRlc05lZWRlZChiaXRMZW4pXG4gIH1cblxuICBjaGFycygpIHtcbiAgICByZXR1cm4gdGhpcy5jaGFyc2V0LmNoYXJzXG4gIH1cblxuICBiaXRzKCkge1xuICAgIHJldHVybiB0aGlzLmJpdExlblxuICB9XG5cbiAgdXNlKGNoYXJzZXQpIHtcbiAgICBpZiAoIShjaGFyc2V0IGluc3RhbmNlb2YgQ2hhclNldCkpIHsgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIENoYXJTZXQnKSB9XG4gICAgdGhpcy5jaGFyc2V0ID0gY2hhcnNldFxuICB9XG5cbiAgdXNlQ2hhcnMoY2hhcnMpIHtcbiAgICBpZiAoISh0eXBlb2YgY2hhcnMgPT09ICdzdHJpbmcnIHx8IGNoYXJzIGluc3RhbmNlb2YgU3RyaW5nKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGNoYXJzOiBNdXN0IGJlIHN0cmluZycpXG4gICAgfVxuICAgIHRoaXMudXNlKG5ldyBDaGFyU2V0KGNoYXJzKSlcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgQ2hhclNldCxcbiAgRW50cm9weSxcbiAgY2hhcnNldDIsXG4gIGNoYXJzZXQ0LFxuICBjaGFyc2V0OCxcbiAgY2hhcnNldDE2LFxuICBjaGFyc2V0MzIsXG4gIGNoYXJzZXQ2NFxufVxuIl19